[tox]
minversion = 3.10.0
requires =
    setuptools >= 30.0.0
    virtualenv >= 20.2
isolated_build = true
skip_missing_interpreters = true

envlist =
    lint
    clean
    docs
    py{37,38,39,310,311}-{asyncio,uvloop}
    pypy3-asyncio
    coverage

[testenv]
setenv =
    COVERAGE_FILE = {env:COVERAGE_FILE:.coverage.{envname}}
    PYTHONUNBUFFERED = {env:PYTHONUNBUFFERED:yes}
    PYTHONWARNINGS = {env:PYTHONWARNINGS:once::DeprecationWarning}
passenv = *
deps =
    pytest>=7,<8
    pytest-asyncio>=0.18,<1
    pytest-cov>=3,<4
    coverage[toml]>=6,<7
    hypothesis>=6,<7
    aiosmtpd>=1.4.2,<2
    trustme>=0.7.0,<1
    uvloop: uvloop>=0.14,<1
commands =
    asyncio: python -m pytest --basetemp="{envtmpdir}" --cov --cov-report= --cov-config=pyproject.toml --junitxml=test-results/{envname}/results.xml --event-loop=asyncio  --bind-addr={env:BIND_ADDR:127.0.0.1} --hypothesis-profile {env:HYPOTHESIS_PROFILE:dev} {posargs:--tb=short}
    uvloop: python -m pytest --basetemp="{envtmpdir}" --cov --cov-report= --cov-config=pyproject.toml --junitxml=test-results/{envname}/results.xml --event-loop=uvloop --bind-addr={env:BIND_ADDR:127.0.0.1} --hypothesis-profile {env:HYPOTHESIS_PROFILE:dev} {posargs:--tb=short}
depends =
    py{37,38,39,310}-{asyncio,uvloop}: clean
    pypy3-asyncio: clean
    coverage: py37-asyncio, py38-asyncio, py39-asyncio, py310-asyncio, py37-uvloop, py38-uvloop, py39-uvloop, py310-uvloop, pypy3-asyncio

[testenv:docs]
basepython = python3.9
deps =
    {[testenv]deps}
    sphinx>=4,<5
    sphinx_autodoc_typehints>=1.7,<2
changedir = docs
commands =
    sphinx-build {posargs:-nWT} -b doctest -d {envtmpdir}/doctrees . {envtmpdir}/html
    sphinx-build {posargs:-nWT} -b dummy -d {envtmpdir}/doctrees .  {envtmpdir}/html

[testenv:lint]
deps =
    pre-commit
basepython = python3.9
skip_install = true
commands =
    pre-commit run --all-files --show-diff-on-failure

[testenv:coverage]
deps = coverage[toml]>=6,<7
skip_install = true
setenv =
    COVERAGE_FILE = .coverage
commands =
    coverage combine
    coverage xml
    coverage html
    coverage report --fail-under=90

[testenv:clean]
deps = {[testenv:coverage]deps}
setenv = {[testenv:coverage]setenv}
skip_install = true
commands =
    coverage combine
    coverage erase
